# 2026-02-19 作業ログ

## 概要

クラスタリング分析（K-Means / DBSCAN）の実装を完了した。特徴量抽出、クラスタリングエンジン、予測生成、分析レポート、CLIの計5ファイルを新規作成し、ユニットテスト（36件）も整備した。さらに plotly によるインタラクティブ可視化機能も追加した。

## 実施内容

### 1. 依存パッケージの追加

- **scikit-learn** (v1.8.0) — K-Means / DBSCAN クラスタリング、PCA次元削減
- **numpy** (既存) — 特徴量行列の操作
- `requirements.txt` を更新（`scikit-learn`, `numpy`, `plotly` を有効化）

### 2. 特徴量抽出モジュール（`src/clustering/feature_extractor.py`）

- 6次元の特徴量ベクトルを生成

| # | 特徴量 | 説明 |
|---|--------|------|
| 1 | `sum_total` | 本数字の合計値 |
| 2 | `mean` | 本数字の平均値 |
| 3 | `std_dev` | 本数字の標準偏差 |
| 4 | `range_span` | 最大値 − 最小値 |
| 5 | `odd_ratio` | 奇数の割合（0.0〜1.0）|
| 6 | `high_ratio` | 上半分（≥中央値）の割合（0.0〜1.0）|

### 3. クラスタリングエンジン（`src/clustering/engine.py`）

- **K-Means** — `run_kmeans()` + エルボー法によるk自動推定 `find_optimal_k()`
- **DBSCAN** — `run_dbscan()` + k-距離法によるeps自動推定
- `ClusteringResult` データクラスで結果を統一管理
- 全特徴量は `StandardScaler` で標準化してからクラスタリングに投入

### 4. 予測生成モジュール（`src/clustering/predictor.py`）

- 3つの予測戦略を実装:
  - **centroid** — 最大クラスタの重心に近い実データから頻出数字を重み付きサンプリング
  - **recent** — 直近開催回が属するクラスタから時系列重み付きサンプリング
  - **pocket** — コールドナンバー（期待値以下の出現数字）を重点サンプリング

### 5. 分析レポートモジュール（`src/clustering/analyzer.py`）

- クラスタ別サマリー（件数・割合・代表番号）
- クラスタ重心の特徴量テーブル
- 予測結果一覧表示

### 6. CLIエントリーポイント（`src/clustering/__main__.py`）

- `python -m src.clustering` で実行可能
- `argparse` によるオプション:
  - `--game`: loto6 / loto7 / miniloto
  - `--method`: kmeans / dbscan / both
  - `--clusters`: クラスタ数（省略時: エルボー法自動推定）
  - `--recent`: 直近N回のみ使用
  - `--predictions`: 予測セット数
  - `--strategy`: centroid / recent / pocket
  - `--visualize`: HTML可視化
  - `--output-dir`: 出力先

### 7. テストの作成（`tests/test_clustering.py`）

- **TestFeatureExtractor** — 特徴量抽出テスト（10件）
  - 形状検証、値の妥当性、エッジケース、NaNチェック、3ゲーム分
- **TestClusteringEngine** — エンジンテスト（7件）
  - K-Means / DBSCAN の基本動作、ラベル検証、サイズ整合、エルボー法
- **TestPredictor** — 予測生成テスト（19件）
  - 3戦略 × 5検証項目（件数・個数・範囲・重複・ソート）+ エラーケース + 3ゲーム対応

### 8. plotly インタラクティブ可視化の追加（夜の部）

- **visualizer.py** — plotly HTMLレポート生成
  - ダークテーマ（GitHub風カラーパレット、モンテカルロと統一）
  - 4つのインタラクティブグラフ:
    1. PCA 2D散布図（クラスタ色分け＋重心マーカー、寄与率表示）
    2. クラスタサイズ分布（ドーナツチャート）
    3. クラスタ別特徴量分布（箱ひげ図、6特徴量比較）
    4. 予測番号マップ（ヒートマップ、合計行付き）

### 9. 検証結果

- ユニットテスト: **54件全PASSED**（クラスタリング36件 + 既存18件）（5.14秒）
- CLI実行テスト:

| ゲーム | 手法 | 戦略 | 実行時間 | オプション |
|--------|------|------|----------|-----------|
| ロト6 | both | centroid | ~1.9秒 | デフォルト |
| ロト7 | kmeans | recent | ~1.8秒 | `--game loto7 --method kmeans --strategy recent` |
| ミニロト | dbscan | pocket | ~0.04秒 | `--game miniloto --method dbscan --predictions 10 --strategy pocket` |
| ロト6 | kmeans | centroid | — | `--visualize`（HTML生成確認済み） |

### 10. メンテナンス

- `GEMINI.md` のクラスタリング ステータスを「✅ 実装済」に更新
- `requirements.txt` の `scikit-learn`, `numpy`, `plotly` を有効化

## CLI使用方法

```powershell
# ロト6（デフォルト: K-Means + DBSCAN）
python -m src.clustering

# ロト7、K-Meansのみ、直近200回
python -m src.clustering --game loto7 --method kmeans --recent 200

# ミニロト、DBSCAN、ポケット戦略、予測10セット
python -m src.clustering --game miniloto --method dbscan --strategy pocket --predictions 10

# 可視化HTML生成
python -m src.clustering --visualize

# ヘルプ
python -m src.clustering --help
```

## 新規ファイル一覧

```
src/clustering/feature_extractor.py  # 特徴量抽出（6次元）
src/clustering/engine.py             # K-Means / DBSCAN エンジン
src/clustering/predictor.py          # 予測生成（3戦略）
src/clustering/analyzer.py           # レポート出力
src/clustering/visualizer.py         # plotly可視化
src/clustering/__main__.py           # CLIエントリーポイント
tests/test_clustering.py             # クラスタリングテスト（36件）
```

## コミット履歴

| ハッシュ | メッセージ |
|---------|-----------|
| `a31336b` | 🔬 feat: クラスタリング分析(K-Means/DBSCAN)実装 - 特徴量抽出、エンジン、予測、CLI、テスト36件 |
| `61c669a` | 📊 feat: クラスタリング分析の可視化オプション(--visualize)追加 - PCA散布図、ドーナツチャート、箱ひげ図、予測ヒートマップ |

## 次回やること

- [ ] 遺伝的アルゴリズムの実装（`src/genetic/`）
